(()=>{let e=null,t=null;function n(e,t=null){const n="background: #0066cc; color: white; padding: 2px 5px; border-radius: 3px;";t?console.log("%c[CNKI下载器]",n,e,t):console.log("%c[CNKI下载器]",n,e)}async function r(e){n("开始处理文章下载:",e);try{if(!chrome.runtime?.id)throw new Error("扩展已重新加载，请刷新页面");const t=window.open(e,"_blank"),r=setInterval((()=>{try{if(!chrome.runtime?.id)throw clearInterval(r),new Error("扩展已重新加载，请刷新页面");if(t&&t.document)try{const e=t.document.querySelector("#pdfDown");if(e)return n("找到PDF下载按钮"),e.click(),clearInterval(r),void setTimeout((()=>{try{t.close()}catch(e){n("关闭标签页失败:",e)}}),2e3)}catch(c){return clearInterval(r),o(e)}}catch(c){throw clearInterval(r),new Error("扩展已重新加载，请刷新页面")}}),500);setTimeout((()=>{try{return clearInterval(r),o(e)}catch(t){throw new Error("下载超时，请重试")}}),5e3)}catch(t){return n("下载处理出错:",t),t.message.includes("扩展已重新加载")?(alert("扩展已更新，请刷新页面后重试"),{error:"扩展已更新，请刷新页面后重试"}):{error:t.message}}}function o(e){return new Promise((r=>{try{if(!chrome.runtime?.id)return void r({error:"扩展已重新加载，请刷新页面"});const o=setTimeout((()=>{r({error:"下载请求超时"})}),1e4);chrome.runtime.sendMessage({action:"downloadPDFInBackground",url:e,title:t||"document"},(e=>{if(clearTimeout(o),chrome.runtime.lastError)return n("消息发送错误:",chrome.runtime.lastError),void r({error:chrome.runtime.lastError.message});r(e||{success:!0})}))}catch(o){r({error:"扩展通信错误，请刷新页面重试"})}}))}function c(e){n("开始处理PDF下载");const t=document.querySelector("#pdfDown");if(t)return n("找到ID为pdfDown的下载按钮"),t.click(),void e({success:!0});n("未找到ID为pdfDown的按钮，尝试其他方式");const r=Array.from(document.querySelectorAll("a, button")).filter((e=>e.textContent.includes("PDF下载")||e.getAttribute("title")?.includes("PDF下载")||e.getAttribute("href")?.includes("download.aspx")||e.getAttribute("href")?.includes("download/order")));if(n("找到的其他PDF下载按钮:",r),r.length>0)n("点击找到的PDF下载按钮"),r[0].click(),e({success:!0});else{n("尝试查找下载链接");const t=document.querySelectorAll('a[href*="download/order"], a[href*="download.aspx"]');if(n("找到的下载链接:",t),t.length>0){const r=t[0].href;n("准备创建下载表单:",r);const o=document.createElement("form");o.method="POST",o.action=r,o.target="_blank";const c={filename:document.querySelector(".title, h1, .brief")?.textContent?.trim()||"document",dflag:"pdfdown",showcol:"1"};n("表单参数:",c),Object.entries(c).forEach((([e,t])=>{const n=document.createElement("input");n.type="hidden",n.name=e,n.value=t,o.appendChild(n)})),n("提交下载表单"),document.body.appendChild(o),o.submit(),document.body.removeChild(o),e({success:!0})}else n("未找到任何下载链接"),e({success:!1,error:"未找到PDF下载按钮或下载链接"})}}function i(){if(!document.head)return void window.addEventListener("DOMContentLoaded",i);const e=document.createElement("style");e.textContent="\n    /* 表格行样式优化 */\n    tr.selected {\n      background-color: rgba(0, 113, 227, 0.08) !important;\n      transition: background-color 0.3s ease;\n    }\n    tr.selected td {\n      background-color: transparent !important;\n    }\n    tr:hover {\n      background-color: rgba(0, 113, 227, 0.04);\n    }\n    \n    /* 文章标题样式优化 */\n    .fz14 {\n      transition: all 0.3s ease;\n      text-decoration: none !important;\n    }\n    tr.selected .fz14 {\n      color: #0071e3 !important;\n      font-weight: 500;\n    }\n    \n    /* 下载按钮容器样式 */\n    .cnki-download-buttons {\n      display: inline-flex !important;\n      align-items: center;\n      gap: 8px;\n      margin-left: 10px;\n      vertical-align: middle;\n    }\n    \n    /* 下载按钮基础样式 */\n    .cnki-download-btn {\n      display: inline-flex;\n      align-items: center;\n      justify-content: center;\n      padding: 4px 12px;\n      border-radius: 4px;\n      font-size: 13px;\n      font-weight: 500;\n      cursor: pointer;\n      transition: all 0.2s ease;\n      border: 1px solid transparent;\n      white-space: nowrap;\n      height: 26px;\n      line-height: 1;\n    }\n    \n    /* 主要按钮样式 */\n    .cnki-download-btn.primary {\n      background-color: #1e80ff;\n      color: white;\n    }\n    .cnki-download-btn.primary:hover {\n      background-color: #1b76ed;\n    }\n    .cnki-download-btn.primary:active {\n      background-color: #1867d0;\n    }\n    \n    /* 次要按钮样式 */\n    .cnki-download-btn.secondary {\n      background-color: #f5f6f7;\n      color: #1e80ff;\n      border-color: #e4e6eb;\n    }\n    .cnki-download-btn.secondary:hover {\n      background-color: #e8f3ff;\n      border-color: #1e80ff;\n    }\n    .cnki-download-btn.secondary:active {\n      background-color: #dcebff;\n    }\n  ",document.head.appendChild(e)}function l(e){document.querySelectorAll("tr.selected").forEach((e=>{e.classList.remove("selected")})),e&&e.classList.add("selected")}function d(){n("开始添加下载按钮");let t=document.querySelector('.theme-title, .subject-title, [data-type="subject"], button.subject');if(!t){const e=Array.from(document.querySelectorAll("button, div")),r=e.find((e=>e.textContent.includes("主题")));if(!r)return n("未找到主题按钮，将在1秒后重试"),void setTimeout(d,1e3);t=r}if(document.querySelector(".cnki-download-buttons"))return void n("下载按钮已存在，无需重复添加");const o=document.createElement("div");o.className="cnki-download-buttons",o.style.cssText="\n    display: inline-flex;\n    align-items: center;\n    gap: 8px;\n    margin-right: 10px;\n    vertical-align: middle;\n  ";const c=document.createElement("button");c.textContent="单个下载",c.className="cnki-download-btn secondary",c.style.cssText="\n    background-color: #f5f6f7;\n    color: #1e80ff;\n    border: 1px solid #e4e6eb;\n    padding: 4px 12px;\n    border-radius: 4px;\n    font-size: 13px;\n    font-weight: 500;\n    cursor: pointer;\n    transition: all 0.2s ease;\n    height: 26px;\n    line-height: 1;\n  ",c.onclick=()=>{e?r(e):alert("请先选择要下载的文章")};const i=document.createElement("button");i.textContent="批量下载",i.className="cnki-download-btn primary",i.style.cssText="\n    background-color: #1e80ff;\n    color: white;\n    border: none;\n    padding: 4px 12px;\n    border-radius: 4px;\n    font-size: 13px;\n    font-weight: 500;\n    cursor: pointer;\n    transition: all 0.2s ease;\n    height: 26px;\n    line-height: 1;\n  ",i.onclick=async()=>{try{if(!chrome.runtime?.id)return void alert("扩展已更新，请刷新页面后重试");const t=document.querySelectorAll('input[type="checkbox"]:checked');if(0===t.length)return void alert("请先选择要下载的文章");const o=Array.from(t).map((e=>{const t=e.closest("tr"),n=t.querySelector("a.fz14");return n?{url:n.href,title:n.textContent.trim()}:null})).filter((e=>null!==e));for(const c of o)try{n("开始下载文章:",c.title);const e=await r(c.url);e&&e.error?n(`文章 "${c.title}" 下载失败:`,e.error):n(`文章 "${c.title}" 下载已开始`),await new Promise((e=>setTimeout(e,3e3)))}catch(e){n(`文章 "${c.title}" 下载出错:`,e);continue}}catch(e){n("批量下载出错:",e),alert("下载过程出错，请刷新页面重试")}},o.appendChild(c),o.appendChild(i);try{const e=t.parentNode;if(!e)throw new Error("未找到主题按钮的父元素");e.insertBefore(o,t),n("下载按钮添加完成")}catch(l){n("添加按钮时出错:",l),setTimeout(d,1e3)}}function s(){"loading"===document.readyState?window.addEventListener("DOMContentLoaded",(()=>{i(),d(),a()})):(i(),d(),a())}function a(){const e=new MutationObserver((e=>{for(const t of e)if("childList"===t.type&&t.addedNodes.length>0&&!document.querySelector(".cnki-download-buttons")){d();break}})),t=document.querySelector(".main-content, #content, main");t?e.observe(t,{childList:!0,subtree:!0}):e.observe(document.body,{childList:!0,subtree:!0}),window.addEventListener("unload",(()=>{e.disconnect()}))}document.addEventListener("change",(o=>{const c=o.target;if(n("检测到复选框变化:",{checked:c.checked,element:c}),"checkbox"===c.type){const o=c.closest("td");if(n("找到checkbox所在的td:",o),o){const i=o.closest("tr");if(n("找到所在行:",i),i){const o=i.querySelector("a.fz14");n("查找文章链接:",o),o&&c.checked?(e=o.href,t=o.textContent.trim(),n("成功获取文章信息:",{title:t,url:e}),l(i),r(e).then((e=>{e&&e.error&&(n("下载过程出错:",e.error),alert(`下载失败: ${e.error}`))})).catch((e=>{n("下载过程出错:",e),alert(`下载失败: ${e.message}`)}))):c.checked||(e=null,t=null,l(null))}}}})),document.addEventListener("click",(n=>{const r=n.target.closest("a.fz14");r&&(e=r.href,t=r.textContent.trim(),console.log("点击文章:",{title:t,url:e}),chrome.runtime.sendMessage({action:"articleSelected",url:e,title:t}),l(r.closest("tr")))})),chrome.runtime.onMessage.addListener(((t,n,r)=>{if("downloadCurrentPDF"===t.action){try{if(window.location.href.includes("/article/detail")||window.location.href.includes("/article/abstract")||window.location.href.includes(".webvpn.")&&(window.location.href.includes("/kns8/Detail")||window.location.href.includes("/kns8/defaultresult/index")))c(r),t.autoClose&&setTimeout((()=>{chrome.runtime.sendMessage({action:"closeCurrentTab"})}),1e3);else if(e){const t=e.includes(".webvpn.")?e:e.replace("https://","https://kns-cnki-net-443.webvpn.zisu.edu.cn/");r({success:!0,needsRedirect:!0,redirectUrl:t})}else r({success:!1,error:"请先选择要下载的文章"})}catch(o){console.error("PDF下载错误:",o),r({success:!1,error:"下载失败："+o.message})}return!0}if("startBatchDownload"===t.action){const e=document.querySelectorAll('input[type="checkbox"]:checked'),t=Array.from(e).map((e=>{const t=e.closest("tr"),n=t.querySelector("a.fz14");return{title:n.textContent.trim(),url:n.href}}));return 0===t.length?void r({success:!1,error:"请先选择要下载的文章"}):(r({success:!0,total:t.length,articles:t}),!0)}if("downloadPDFInBackground"===t.action)return chrome.tabs.create({url:t.url,active:!1},(e=>{chrome.tabs.onUpdated.addListener((function t(n,o){n===e.id&&"complete"===o.status&&(chrome.tabs.onUpdated.removeListener(t),chrome.scripting.executeScript({target:{tabId:e.id},function:()=>{const e=document.querySelector("#pdfDown");return!!e&&(e.click(),setTimeout((()=>{chrome.runtime.sendMessage({action:"closeCurrentTab"})}),1e3),!0)}},(t=>{t&&t[0]?.result||r({error:"未找到PDF下载按钮"}),setTimeout((()=>{chrome.tabs.remove(e.id)}),2e3)})))}))})),!0})),i(),s()})();