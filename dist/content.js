(()=>{let e=null,t=null,n=0;const o=3;function r(e,t=null){const n="background: #0066cc; color: white; padding: 2px 5px; border-radius: 3px;";t?console.log("%c[CNKI下载器]",n,e,t):console.log("%c[CNKI下载器]",n,e)}function c(e){r("开始处理PDF下载");const t=document.querySelector("#pdfDown");if(t)return r("找到ID为pdfDown的下载按钮"),t.click(),void e({success:!0});r("未找到ID为pdfDown的按钮，尝试其他方式");const n=Array.from(document.querySelectorAll("a, button")).filter((e=>e.textContent.includes("PDF下载")||e.getAttribute("title")?.includes("PDF下载")||e.getAttribute("href")?.includes("download.aspx")||e.getAttribute("href")?.includes("download/order")));if(r("找到的其他PDF下载按钮:",n),n.length>0)r("点击找到的PDF下载按钮"),n[0].click(),e({success:!0});else{r("尝试查找下载链接");const t=document.querySelectorAll('a[href*="download/order"], a[href*="download.aspx"]');if(r("找到的下载链接:",t),t.length>0){const n=t[0].href;r("准备创建下载表单:",n);const o=document.createElement("form");o.method="POST",o.action=n,o.target="_blank";const c={filename:document.querySelector(".title, h1, .brief")?.textContent?.trim()||"document",dflag:"pdfdown",showcol:"1"};r("表单参数:",c),Object.entries(c).forEach((([e,t])=>{const n=document.createElement("input");n.type="hidden",n.name=e,n.value=t,o.appendChild(n)})),r("提交下载表单"),document.body.appendChild(o),o.submit(),document.body.removeChild(o),e({success:!0})}else r("未找到任何下载链接"),e({success:!1,error:"未找到PDF下载按钮或下载链接"})}}function i(){if(!document.head)return void window.addEventListener("DOMContentLoaded",i);const e=document.createElement("style");e.textContent="\n    /* 表格行样式优化 */\n    tr.selected {\n      background-color: rgba(0, 113, 227, 0.08) !important;\n      transition: background-color 0.3s ease;\n    }\n    tr.selected td {\n      background-color: transparent !important;\n    }\n    tr:hover {\n      background-color: rgba(0, 113, 227, 0.04);\n    }\n    \n    /* 文章标题样式优化 */\n    .fz14 {\n      transition: all 0.3s ease;\n      text-decoration: none !important;\n    }\n    tr.selected .fz14 {\n      color: #0071e3 !important;\n      font-weight: 500;\n    }\n    \n    /* 下载按钮容器样式 */\n    .cnki-download-buttons {\n      display: inline-flex !important;\n      align-items: center;\n      gap: 8px;\n      margin-left: 10px;\n      vertical-align: middle;\n    }\n    \n    /* 下载按钮基础样式 */\n    .cnki-download-btn {\n      display: inline-flex;\n      align-items: center;\n      justify-content: center;\n      padding: 4px 12px;\n      border-radius: 4px;\n      font-size: 13px;\n      font-weight: 500;\n      cursor: pointer;\n      transition: all 0.2s ease;\n      border: 1px solid transparent;\n      white-space: nowrap;\n      height: 26px;\n      line-height: 1;\n    }\n    \n    /* 主要按钮样式 */\n    .cnki-download-btn.primary {\n      background-color: #1e80ff;\n      color: white;\n    }\n    .cnki-download-btn.primary:hover {\n      background-color: #1b76ed;\n    }\n    .cnki-download-btn.primary:active {\n      background-color: #1867d0;\n    }\n    \n    /* 次要按钮样式 */\n    .cnki-download-btn.secondary {\n      background-color: #f5f6f7;\n      color: #1e80ff;\n      border-color: #e4e6eb;\n    }\n    .cnki-download-btn.secondary:hover {\n      background-color: #e8f3ff;\n      border-color: #1e80ff;\n    }\n    .cnki-download-btn.secondary:active {\n      background-color: #dcebff;\n    }\n  ",document.head.appendChild(e)}function d(e){document.querySelectorAll("tr.selected").forEach((e=>{e.classList.remove("selected")})),e&&e.classList.add("selected")}function l(){if(r(`开始添加下载按钮 (重试次数: ${n}/${o})`),n>=o)return r("已达到最大重试次数，停止重试"),void f("无法加载下载按钮，请刷新页面重试");if(document.querySelector(".cnki-download-buttons"))return void r("下载按钮已存在，无需重复添加");let e=null,t=null;if(e=document.querySelector(".theme-title, .subject-title"),e||(e=document.querySelector(".toolbar, .tools, .tool-bar")),e||(e=document.querySelector(".operat, .operation, .grid-tool")),!e){const t=document.querySelector(".result-table-list, .GridTableContent");if(t){const n=document.createElement("div");n.className="cnki-custom-toolbar",n.style.cssText="margin: 10px 0; padding: 10px; background: #f5f6f7; border-radius: 4px;",t.parentNode.insertBefore(n,t),e=n}}if(e){r("找到插入位置:",e);const o=document.createElement("div");o.className="cnki-download-buttons";const i=document.createElement("button");i.textContent="单个下载",i.className="cnki-download-btn secondary",i.style.cssText="\n          background-color: #f5f6f7;\n          color: #1e80ff;\n          border: 1px solid #e4e6eb;\n          padding: 4px 12px;\n          border-radius: 4px;\n          font-size: 13px;\n          font-weight: 500;\n          cursor: pointer;\n          transition: all 0.2s ease;\n          height: 26px;\n          line-height: 1;\n        ",i.onclick=()=>{const e=document.querySelectorAll('input[type="checkbox"]:checked'),t=Array.from(e).filter((e=>{const t=e.closest("tr");return t&&t.querySelector("a.fz14")}));if(t.length>1)return void alert("已选择多篇文章，请使用批量下载按钮");if(0===t.length)return void alert("请先选择要下载的文章");const n=t[0].closest("tr"),o=n.querySelector("a.fz14");o?chrome.runtime.sendMessage({action:"silentDownloadPDF",url:o.href,title:o.textContent.trim()},(e=>{e?.error&&(r("下载过程出错:",e.error),alert(`下载失败: ${e.error}`))})):alert("无法获取文章信息")};const d=document.createElement("button");d.textContent="批量下载",d.className="cnki-download-btn primary",d.style.cssText="\n          background-color: #1e80ff;\n          color: white;\n          border: none;\n          padding: 4px 12px;\n          border-radius: 4px;\n          font-size: 13px;\n          font-weight: 500;\n          cursor: pointer;\n          transition: all 0.2s ease;\n          height: 26px;\n          line-height: 1;\n        ",d.onclick=async()=>{try{const e=Array.from(document.querySelectorAll('input[type="checkbox"]:checked')).filter((e=>{const t=e.closest("tr");return t&&t.querySelector("a.fz14")}));if(0===e.length)return void alert("请先选择要下载的文章");if(1===e.length)return void alert("只选择了一篇文章，请使用单个下载按钮");const t=e.map((e=>{const t=e.closest("tr"),n=t.querySelector("a.fz14");return n?{url:n.href,title:n.textContent.trim()}:null})).filter((e=>null!==e));chrome.runtime.sendMessage({action:"batchDownloadWithSingleSave",articles:t},(e=>{e?.error?(r("批量下载出错:",e.error),alert(`批量下载失败: ${e.error}`)):r("批量下载已开始")}))}catch(e){r("批量下载出错:",e),alert("下载过程出错，请刷新页面重试")}},o.appendChild(i),o.appendChild(d);try{return t?e.insertBefore(o,t):e.appendChild(o),r("下载按钮添加成功"),void(n=0)}catch(c){r("添加按钮时出错:",c)}}n++,n<o?(r(`未找到合适的插入位置，1000ms后重试 (${n}/${o})`),setTimeout(l,1e3)):(r("无法找到合适的插入位置，已停止重试"),f("无法加载下载按钮，请刷新页面重试"))}function a(){n=0,setTimeout((()=>{i(),l(),s()}),1e3)}function s(){const e=new MutationObserver((e=>{for(const t of e)if("childList"===t.type&&t.addedNodes.length>0&&!document.querySelector(".cnki-download-buttons")){n=0,l();break}})),t=document.querySelector(".main-content, #content, main");t?e.observe(t,{childList:!0,subtree:!0}):e.observe(document.body,{childList:!0,subtree:!0}),window.addEventListener("unload",(()=>{e.disconnect()}))}function u(){if(!document.body)return void window.addEventListener("DOMContentLoaded",u);const e=document.createElement("style");e.textContent="\n        .cnki-download-notification {\n            position: fixed;\n            top: 50%;\n            left: 50%;\n            transform: translate(-50%, -50%);\n            background-color: rgba(0, 0, 0, 0.8);\n            color: white;\n            padding: 15px 25px;\n            border-radius: 8px;\n            z-index: 9999;\n            animation: fadeInOut 3s ease-in-out;\n            font-size: 14px;\n            max-width: 80%;\n            text-align: center;\n            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);\n            white-space: pre-line;\n        }\n\n        @keyframes fadeInOut {\n            0% { opacity: 0; transform: translate(-50%, -40%); }\n            10% { opacity: 1; transform: translate(-50%, -50%); }\n            90% { opacity: 1; transform: translate(-50%, -50%); }\n            100% { opacity: 0; transform: translate(-50%, -60%); }\n        }\n\n        .selected-article {\n            background-color: #f0f7ff !important;\n        }\n    ",document.body.appendChild(e)}function f(e){const t=document.querySelector(".cnki-download-notification");t&&t.remove();const n=document.createElement("div");n.className="cnki-download-notification",n.textContent=e,document.body.appendChild(n),setTimeout((()=>{n&&n.parentNode&&n.remove()}),3e3)}document.addEventListener("change",(n=>{const o=n.target;if(r("检测到复选框变化:",{checked:o.checked,element:o}),"checkbox"===o.type){const n=o.closest("td");if(r("找到checkbox所在的td:",n),n){const c=n.closest("tr");if(r("找到所在行:",c),c){const n=c.querySelector("a.fz14");r("查找文章链接:",n),n&&o.checked?(e=n.href,t=n.textContent.trim(),r("成功获取文章信息:",{title:t,url:e}),d(c)):o.checked||(e=null,t=null,d(null))}}}})),document.addEventListener("click",(n=>{const o=n.target.closest("a.fz14");o&&(e=o.href,t=o.textContent.trim(),console.log("点击文章:",{title:t,url:e}),chrome.runtime.sendMessage({action:"articleSelected",url:e,title:t}),d(o.closest("tr")))})),chrome.runtime.onMessage.addListener(((t,n,o)=>{if("downloadCurrentPDF"===t.action){try{if(window.location.href.includes("/article/detail")||window.location.href.includes("/article/abstract")||window.location.href.includes(".webvpn.")&&(window.location.href.includes("/kns8/Detail")||window.location.href.includes("/kns8/defaultresult/index")))c(o),t.autoClose&&setTimeout((()=>{chrome.runtime.sendMessage({action:"closeCurrentTab"})}),1e3);else if(e){const t=e.includes(".webvpn.")?e:e.replace("https://","https://kns-cnki-net-443.webvpn.zisu.edu.cn/");o({success:!0,needsRedirect:!0,redirectUrl:t})}else o({success:!1,error:"请先选择要下载的文章"})}catch(r){console.error("PDF下载错误:",r),o({success:!1,error:"下载失败："+r.message})}return!0}if("startBatchDownload"===t.action){const e=document.querySelectorAll('input[type="checkbox"]:checked'),t=Array.from(e).map((e=>{const t=e.closest("tr"),n=t.querySelector("a.fz14");return{title:n.textContent.trim(),url:n.href}}));return 0===t.length?void o({success:!1,error:"请先选择要下载的文章"}):(o({success:!0,total:t.length,articles:t}),!0)}return"downloadPDFInBackground"===t.action?(chrome.tabs.create({url:t.url,active:!1},(e=>{chrome.tabs.onUpdated.addListener((function t(n,r){n===e.id&&"complete"===r.status&&(chrome.tabs.onUpdated.removeListener(t),chrome.scripting.executeScript({target:{tabId:e.id},function:()=>{const e=document.querySelector("#pdfDown");return!!e&&(e.click(),setTimeout((()=>{chrome.runtime.sendMessage({action:"closeCurrentTab"})}),1e3),!0)}},(t=>{t&&t[0]?.result||o({error:"未找到PDF下载按钮"}),setTimeout((()=>{chrome.tabs.remove(e.id)}),2e3)})))}))})),!0):"showNotification"===t.action?(f(t.message),o({success:!0}),!0):void 0})),i(),a(),u(),document.addEventListener("DOMContentLoaded",(()=>{document.addEventListener("change",(e=>{if("checkbox"===e.target.type){const t=e.target.closest("tr");if(t&&t.querySelector("a.fz14"))if(e.target.checked){t.classList.add("selected-article");const e=t.querySelector("a.fz14").textContent.trim();f(`已选择文章：${e}`)}else t.classList.remove("selected-article"),f("已取消选择文章")}}));const e=document.querySelector("#downloadBtn");e&&e.addEventListener("click",(()=>{f("开始下载文章...")}));const t=document.querySelector("#batchDownloadBtn");t&&t.addEventListener("click",(()=>{const e=document.querySelectorAll('input[type="checkbox"]:checked').length;f(`开始批量下载 ${e} 篇文章...`)}))}))})();