(()=>{let e=null,n=null;function t(e,n=null){const t="background: #0066cc; color: white; padding: 2px 5px; border-radius: 3px;";n?console.log("%c[CNKI下载器]",t,e,n):console.log("%c[CNKI下载器]",t,e)}function o(e){t("开始处理PDF下载");const n=document.querySelector("#pdfDown");if(n)return t("找到ID为pdfDown的下载按钮"),n.click(),void e({success:!0});t("未找到ID为pdfDown的按钮，尝试其他方式");const o=Array.from(document.querySelectorAll("a, button")).filter((e=>e.textContent.includes("PDF下载")||e.getAttribute("title")?.includes("PDF下载")||e.getAttribute("href")?.includes("download.aspx")||e.getAttribute("href")?.includes("download/order")));if(t("找到的其他PDF下载按钮:",o),o.length>0)t("点击找到的PDF下载按钮"),o[0].click(),e({success:!0});else{t("尝试查找下载链接");const n=document.querySelectorAll('a[href*="download/order"], a[href*="download.aspx"]');if(t("找到的下载链接:",n),n.length>0){const o=n[0].href;t("准备创建下载表单:",o);const r=document.createElement("form");r.method="POST",r.action=o,r.target="_blank";const c={filename:document.querySelector(".title, h1, .brief")?.textContent?.trim()||"document",dflag:"pdfdown",showcol:"1"};t("表单参数:",c),Object.entries(c).forEach((([e,n])=>{const t=document.createElement("input");t.type="hidden",t.name=e,t.value=n,r.appendChild(t)})),t("提交下载表单"),document.body.appendChild(r),r.submit(),document.body.removeChild(r),e({success:!0})}else t("未找到任何下载链接"),e({success:!1,error:"未找到PDF下载按钮或下载链接"})}}function r(){if(!document.head)return void window.addEventListener("DOMContentLoaded",r);const e=document.createElement("style");e.textContent="\n    /* 表格行样式优化 */\n    tr.selected {\n      background-color: rgba(0, 113, 227, 0.08) !important;\n      transition: background-color 0.3s ease;\n    }\n    tr.selected td {\n      background-color: transparent !important;\n    }\n    tr:hover {\n      background-color: rgba(0, 113, 227, 0.04);\n    }\n    \n    /* 文章标题样式优化 */\n    .fz14 {\n      transition: all 0.3s ease;\n      text-decoration: none !important;\n    }\n    tr.selected .fz14 {\n      color: #0071e3 !important;\n      font-weight: 500;\n    }\n    \n    /* 下载按钮容器样式 */\n    .cnki-download-buttons {\n      display: inline-flex !important;\n      align-items: center;\n      gap: 8px;\n      margin-left: 10px;\n      vertical-align: middle;\n    }\n    \n    /* 下载按钮基础样式 */\n    .cnki-download-btn {\n      display: inline-flex;\n      align-items: center;\n      justify-content: center;\n      padding: 4px 12px;\n      border-radius: 4px;\n      font-size: 13px;\n      font-weight: 500;\n      cursor: pointer;\n      transition: all 0.2s ease;\n      border: 1px solid transparent;\n      white-space: nowrap;\n      height: 26px;\n      line-height: 1;\n    }\n    \n    /* 主要按钮样式 */\n    .cnki-download-btn.primary {\n      background-color: #1e80ff;\n      color: white;\n    }\n    .cnki-download-btn.primary:hover {\n      background-color: #1b76ed;\n    }\n    .cnki-download-btn.primary:active {\n      background-color: #1867d0;\n    }\n    \n    /* 次要按钮样式 */\n    .cnki-download-btn.secondary {\n      background-color: #f5f6f7;\n      color: #1e80ff;\n      border-color: #e4e6eb;\n    }\n    .cnki-download-btn.secondary:hover {\n      background-color: #e8f3ff;\n      border-color: #1e80ff;\n    }\n    .cnki-download-btn.secondary:active {\n      background-color: #dcebff;\n    }\n  ",document.head.appendChild(e)}function c(e){document.querySelectorAll("tr.selected").forEach((e=>{e.classList.remove("selected")})),e&&e.classList.add("selected")}function i(){t("开始添加下载按钮");let e=document.querySelector('.theme-title, .subject-title, [data-type="subject"], button.subject');if(!e){const n=Array.from(document.querySelectorAll("button, div")),o=n.find((e=>e.textContent.includes("主题")));if(!o)return t("未找到主题按钮，将在1秒后重试"),void setTimeout(i,1e3);e=o}if(document.querySelector(".cnki-download-buttons"))return void t("下载按钮已存在，无需重复添加");const n=document.createElement("div");n.className="cnki-download-buttons",n.style.cssText="\n    display: inline-flex;\n    align-items: center;\n    gap: 8px;\n    margin-right: 10px;\n    vertical-align: middle;\n  ";const o=document.createElement("button");o.textContent="单个下载",o.className="cnki-download-btn secondary",o.style.cssText="\n    background-color: #f5f6f7;\n    color: #1e80ff;\n    border: 1px solid #e4e6eb;\n    padding: 4px 12px;\n    border-radius: 4px;\n    font-size: 13px;\n    font-weight: 500;\n    cursor: pointer;\n    transition: all 0.2s ease;\n    height: 26px;\n    line-height: 1;\n  ",o.onclick=()=>{const e=document.querySelectorAll('input[type="checkbox"]:checked'),n=Array.from(e).filter((e=>{const n=e.closest("tr");return n&&n.querySelector("a.fz14")}));if(n.length>1)return void alert("已选择多篇文章，请使用批量下载按钮");if(0===n.length)return void alert("请先选择要下载的文章");const o=n[0].closest("tr"),r=o.querySelector("a.fz14");r?chrome.runtime.sendMessage({action:"silentDownloadPDF",url:r.href,title:r.textContent.trim()},(e=>{e?.error&&(t("下载过程出错:",e.error),alert(`下载失败: ${e.error}`))})):alert("无法获取文章信息")};const r=document.createElement("button");r.textContent="批量下载",r.className="cnki-download-btn primary",r.style.cssText="\n    background-color: #1e80ff;\n    color: white;\n    border: none;\n    padding: 4px 12px;\n    border-radius: 4px;\n    font-size: 13px;\n    font-weight: 500;\n    cursor: pointer;\n    transition: all 0.2s ease;\n    height: 26px;\n    line-height: 1;\n  ",r.onclick=async()=>{try{const e=Array.from(document.querySelectorAll('input[type="checkbox"]:checked')).filter((e=>{const n=e.closest("tr");return n&&n.querySelector("a.fz14")}));if(0===e.length)return void alert("请先选择要下载的文章");if(1===e.length)return void alert("只选择了一篇文章，请使用单个下载按钮");const n=e.map((e=>{const n=e.closest("tr"),t=n.querySelector("a.fz14");return t?{url:t.href,title:t.textContent.trim()}:null})).filter((e=>null!==e));chrome.runtime.sendMessage({action:"silentBatchDownload",articles:n},(e=>{e?.error&&(t("批量下载出错:",e.error),alert(`批量下载失败: ${e.error}`))}))}catch(e){t("批量下载出错:",e),alert("下载过程出错，请刷新页面重试")}},n.appendChild(o),n.appendChild(r);try{const o=e.parentNode;if(!o)throw new Error("未找到主题按钮的父元素");o.insertBefore(n,e),t("下载按钮添加完成")}catch(c){t("添加按钮时出错:",c),setTimeout(i,1e3)}}function l(){"loading"===document.readyState?window.addEventListener("DOMContentLoaded",(()=>{r(),i(),d()})):(r(),i(),d())}function d(){const e=new MutationObserver((e=>{for(const n of e)if("childList"===n.type&&n.addedNodes.length>0&&!document.querySelector(".cnki-download-buttons")){i();break}})),n=document.querySelector(".main-content, #content, main");n?e.observe(n,{childList:!0,subtree:!0}):e.observe(document.body,{childList:!0,subtree:!0}),window.addEventListener("unload",(()=>{e.disconnect()}))}document.addEventListener("change",(o=>{const r=o.target;if(t("检测到复选框变化:",{checked:r.checked,element:r}),"checkbox"===r.type){const o=r.closest("td");if(t("找到checkbox所在的td:",o),o){const i=o.closest("tr");if(t("找到所在行:",i),i){const o=i.querySelector("a.fz14");t("查找文章链接:",o),o&&r.checked?(e=o.href,n=o.textContent.trim(),t("成功获取文章信息:",{title:n,url:e}),c(i)):r.checked||(e=null,n=null,c(null))}}}})),document.addEventListener("click",(t=>{const o=t.target.closest("a.fz14");o&&(e=o.href,n=o.textContent.trim(),console.log("点击文章:",{title:n,url:e}),chrome.runtime.sendMessage({action:"articleSelected",url:e,title:n}),c(o.closest("tr")))})),chrome.runtime.onMessage.addListener(((n,t,r)=>{if("downloadCurrentPDF"===n.action){try{if(window.location.href.includes("/article/detail")||window.location.href.includes("/article/abstract")||window.location.href.includes(".webvpn.")&&(window.location.href.includes("/kns8/Detail")||window.location.href.includes("/kns8/defaultresult/index")))o(r),n.autoClose&&setTimeout((()=>{chrome.runtime.sendMessage({action:"closeCurrentTab"})}),1e3);else if(e){const n=e.includes(".webvpn.")?e:e.replace("https://","https://kns-cnki-net-443.webvpn.zisu.edu.cn/");r({success:!0,needsRedirect:!0,redirectUrl:n})}else r({success:!1,error:"请先选择要下载的文章"})}catch(c){console.error("PDF下载错误:",c),r({success:!1,error:"下载失败："+c.message})}return!0}if("startBatchDownload"===n.action){const e=document.querySelectorAll('input[type="checkbox"]:checked'),n=Array.from(e).map((e=>{const n=e.closest("tr"),t=n.querySelector("a.fz14");return{title:t.textContent.trim(),url:t.href}}));return 0===n.length?void r({success:!1,error:"请先选择要下载的文章"}):(r({success:!0,total:n.length,articles:n}),!0)}if("downloadPDFInBackground"===n.action)return chrome.tabs.create({url:n.url,active:!1},(e=>{chrome.tabs.onUpdated.addListener((function n(t,o){t===e.id&&"complete"===o.status&&(chrome.tabs.onUpdated.removeListener(n),chrome.scripting.executeScript({target:{tabId:e.id},function:()=>{const e=document.querySelector("#pdfDown");return!!e&&(e.click(),setTimeout((()=>{chrome.runtime.sendMessage({action:"closeCurrentTab"})}),1e3),!0)}},(n=>{n&&n[0]?.result||r({error:"未找到PDF下载按钮"}),setTimeout((()=>{chrome.tabs.remove(e.id)}),2e3)})))}))})),!0})),r(),l()})();