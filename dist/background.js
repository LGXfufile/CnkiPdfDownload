(()=>{chrome.runtime.onMessage.addListener(((e,t,o)=>{"startDownload"===e.action&&o({success:!0})})),chrome.runtime.onMessage.addListener(((e,t,o)=>{if("closeCurrentTab"===e.action&&t.tab)return chrome.tabs.remove(t.tab.id),!0;if("downloadCurrentPDF"===e.action)return chrome.tabs.query({active:!0,currentWindow:!0},(async([e])=>{try{const t=await chrome.tabs.sendMessage(e.id,{action:"downloadCurrentPDF"});t.needsRedirect&&t.redirectUrl&&(await chrome.tabs.update(e.id,{url:t.redirectUrl}),chrome.tabs.onUpdated.addListener((function t(o,n){o===e.id&&"complete"===n.status&&(chrome.tabs.onUpdated.removeListener(t),setTimeout((async()=>{await chrome.tabs.sendMessage(e.id,{action:"downloadCurrentPDF"})}),2e3))}))),o(t)}catch(t){console.error("下载处理错误:",t),o({success:!1,error:t.message})}})),!0;if("openArticleAndDownload"===e.action)return chrome.tabs.create({url:e.url,active:!1},(e=>{function t(o,n){o===e.id&&"complete"===n.status&&(chrome.tabs.onUpdated.removeListener(t),setTimeout((()=>{chrome.tabs.sendMessage(e.id,{action:"downloadCurrentPDF",autoClose:!0})}),2e3))}chrome.tabs.onUpdated.addListener(t)})),o({success:!0}),!0;if("batchDownload"===e.action){const c=e.urls;let s=0;function n(){if(s>=c.length)return void o({success:!0,message:"批量下载完成"});const e=c[s];chrome.tabs.create({url:e,active:!1},(e=>{function t(o,r){o===e.id&&"complete"===r.status&&(chrome.tabs.onUpdated.removeListener(t),setTimeout((()=>{chrome.tabs.sendMessage(e.id,{action:"downloadCurrentPDF",autoClose:!0},(()=>{s++,n()}))}),2e3))}chrome.tabs.onUpdated.addListener(t)}))}return n(),!0}if("silentDownloadPDF"===e.action)return chrome.tabs.create({url:e.url,active:!1},(e=>{chrome.tabs.onUpdated.addListener((function t(n,r){n===e.id&&"complete"===r.status&&(chrome.tabs.onUpdated.removeListener(t),chrome.scripting.executeScript({target:{tabId:e.id},function:()=>{const e=document.querySelector("#pdfDown");return!!e&&(e.click(),!0)}},(t=>{setTimeout((()=>{chrome.tabs.remove(e.id)}),2e3),t&&t[0]?.result?o({success:!0}):o({error:"未找到PDF下载按钮"})})))}))})),!0;if("silentBatchDownload"===e.action){const a=e.articles;let i=0;function n(){if(i>=a.length)return void o({success:!0});const e=a[i];chrome.tabs.create({url:e.url,active:!1},(e=>{chrome.tabs.onUpdated.addListener((function t(o,r){o===e.id&&"complete"===r.status&&(chrome.tabs.onUpdated.removeListener(t),chrome.scripting.executeScript({target:{tabId:e.id},function:()=>{const e=document.querySelector("#pdfDown");return!!e&&(e.click(),!0)}},(()=>{setTimeout((()=>{chrome.tabs.remove(e.id),i++,setTimeout(n,2e3)}),2e3)})))}))}))}return n(),!0}if("batchDownloadWithSingleSave"===e.action){const d=e.articles;let l=0;async function r(){if(l>=d.length)return console.log("[批量下载] 所有文章处理完成"),void o({success:!0});const e=d[l];console.log(`[批量下载] 正在处理第 ${l+1}/${d.length} 篇文章:`,e.title);try{console.log(`[批量下载] 创建新标签页打开文章: ${e.url}`);const t=await chrome.tabs.create({url:e.url,active:!1});chrome.tabs.onUpdated.addListener((function e(o,n){o===t.id&&"complete"===n.status&&(console.log("[批量下载] 文章页面加载完成，准备查找下载按钮"),chrome.tabs.onUpdated.removeListener(e),chrome.scripting.executeScript({target:{tabId:t.id},function:()=>{const e=document.querySelector("#pdfDown");return e?(console.log("[批量下载] 找到下载按钮，触发点击"),e.click(),!0):(console.log("[批量下载] 未找到下载按钮"),!1)}},(e=>{const o=e&&e[0]?.result;console.log("[批量下载] 下载按钮点击"+(o?"成功":"失败")),setTimeout((()=>{console.log("[批量下载] 关闭标签页，准备处理下一篇文章"),chrome.tabs.remove(t.id),l++,setTimeout(r,2e3)}),3e3)})))}))}catch(t){console.error("[批量下载] 处理文章出错:",t),console.log("[批量下载] 跳过当前文章，继续处理下一篇"),l++,setTimeout(r,2e3)}}return console.log(`[批量下载] 开始处理 ${d.length} 篇文章的下载队列`),r(),!0}})),chrome.downloads.onDeterminingFilename.addListener(((e,t)=>{e.filename.endsWith(".pdf")&&(console.log(`[下载] 开始下载文件: ${e.filename}`),t())})),chrome.downloads.onChanged.addListener((e=>{e.state&&console.log("[下载] 文件下载状态变更:",e)}))})();