(()=>{chrome.runtime.onMessage.addListener(((e,t,o)=>{"startDownload"===e.action&&o({success:!0})})),chrome.runtime.onMessage.addListener(((e,t,o)=>{if("closeCurrentTab"===e.action&&t.tab)return chrome.tabs.remove(t.tab.id),!0;if("downloadCurrentPDF"===e.action)return chrome.tabs.query({active:!0,currentWindow:!0},(async([e])=>{try{const t=await chrome.tabs.sendMessage(e.id,{action:"downloadCurrentPDF"});t.needsRedirect&&t.redirectUrl&&(await chrome.tabs.update(e.id,{url:t.redirectUrl}),chrome.tabs.onUpdated.addListener((function t(o,r){o===e.id&&"complete"===r.status&&(chrome.tabs.onUpdated.removeListener(t),setTimeout((async()=>{await chrome.tabs.sendMessage(e.id,{action:"downloadCurrentPDF"})}),2e3))}))),o(t)}catch(t){console.error("下载处理错误:",t),o({success:!1,error:t.message})}})),!0;if("openArticleAndDownload"===e.action)return chrome.tabs.create({url:e.url,active:!1},(e=>{function t(o,r){o===e.id&&"complete"===r.status&&(chrome.tabs.onUpdated.removeListener(t),setTimeout((()=>{chrome.tabs.sendMessage(e.id,{action:"downloadCurrentPDF",autoClose:!0})}),2e3))}chrome.tabs.onUpdated.addListener(t)})),o({success:!0}),!0;if("batchDownload"===e.action){const c=e.urls;let s=0;function r(){if(s>=c.length)return void o({success:!0,message:"批量下载完成"});const e=c[s];chrome.tabs.create({url:e,active:!1},(e=>{function t(o,n){o===e.id&&"complete"===n.status&&(chrome.tabs.onUpdated.removeListener(t),setTimeout((()=>{chrome.tabs.sendMessage(e.id,{action:"downloadCurrentPDF",autoClose:!0},(()=>{s++,r()}))}),2e3))}chrome.tabs.onUpdated.addListener(t)}))}return r(),!0}if("silentDownloadPDF"===e.action)return chrome.tabs.create({url:e.url,active:!1},(e=>{chrome.tabs.onUpdated.addListener((function t(r,n){r===e.id&&"complete"===n.status&&(chrome.tabs.onUpdated.removeListener(t),chrome.scripting.executeScript({target:{tabId:e.id},function:()=>{const e=document.querySelector("#pdfDown");return!!e&&(e.click(),!0)}},(t=>{setTimeout((()=>{chrome.tabs.remove(e.id)}),2e3),t&&t[0]?.result?o({success:!0}):o({error:"未找到PDF下载按钮"})})))}))})),!0;if("silentBatchDownload"===e.action){const a=e.articles;let i=0;function r(){if(i>=a.length)return void o({success:!0});const e=a[i];chrome.tabs.create({url:e.url,active:!1},(e=>{chrome.tabs.onUpdated.addListener((function t(o,n){o===e.id&&"complete"===n.status&&(chrome.tabs.onUpdated.removeListener(t),chrome.scripting.executeScript({target:{tabId:e.id},function:()=>{const e=document.querySelector("#pdfDown");return!!e&&(e.click(),!0)}},(()=>{setTimeout((()=>{chrome.tabs.remove(e.id),i++,setTimeout(r,2e3)}),2e3)})))}))}))}return r(),!0}if("batchDownloadWithSingleSave"===e.action){const d=e.articles;let u=0;async function n(){if(u>=d.length)return void o({success:!0});const e=d[u];try{const t=await chrome.tabs.create({url:e.url,active:!1});chrome.tabs.onUpdated.addListener((function e(o,r){o===t.id&&"complete"===r.status&&(chrome.tabs.onUpdated.removeListener(e),chrome.scripting.executeScript({target:{tabId:t.id},function:()=>{const e=document.querySelector("#pdfDown");return!!e&&(e.click(),!0)}},(()=>{setTimeout((()=>{chrome.tabs.remove(t.id),u++,setTimeout(n,2e3)}),2e3)})))}))}catch(t){console.error("下载文章出错:",t),u++,setTimeout(n,2e3)}}return n(),!0}})),chrome.downloads.onDeterminingFilename.addListener(((e,t)=>{e.filename.endsWith(".pdf")&&t()}))})();