(()=>{chrome.runtime.onMessage.addListener(((e,t,o)=>{"startDownload"===e.action&&o({success:!0})})),chrome.runtime.onMessage.addListener(((e,t,o)=>{if("closeCurrentTab"===e.action&&t.tab)return chrome.tabs.remove(t.tab.id),!0;if("downloadCurrentPDF"===e.action)return chrome.tabs.query({active:!0,currentWindow:!0},(async([e])=>{try{const t=await chrome.tabs.sendMessage(e.id,{action:"downloadCurrentPDF"});t.needsRedirect&&t.redirectUrl&&(await chrome.tabs.update(e.id,{url:t.redirectUrl}),chrome.tabs.onUpdated.addListener((function t(o,n){o===e.id&&"complete"===n.status&&(chrome.tabs.onUpdated.removeListener(t),setTimeout((async()=>{await chrome.tabs.sendMessage(e.id,{action:"downloadCurrentPDF"})}),2e3))}))),o(t)}catch(t){console.error("下载处理错误:",t),o({success:!1,error:t.message})}})),!0;if("openArticleAndDownload"===e.action)return chrome.tabs.create({url:e.url,active:!1},(e=>{function t(o,n){o===e.id&&"complete"===n.status&&(chrome.tabs.onUpdated.removeListener(t),setTimeout((()=>{chrome.tabs.sendMessage(e.id,{action:"downloadCurrentPDF",autoClose:!0})}),2e3))}chrome.tabs.onUpdated.addListener(t)})),o({success:!0}),!0;if("batchDownload"===e.action){const r=e.urls;let c=0;function n(){if(c>=r.length)return void o({success:!0,message:"批量下载完成"});const e=r[c];chrome.tabs.create({url:e,active:!1},(e=>{function t(o,s){o===e.id&&"complete"===s.status&&(chrome.tabs.onUpdated.removeListener(t),setTimeout((()=>{chrome.tabs.sendMessage(e.id,{action:"downloadCurrentPDF",autoClose:!0},(()=>{c++,n()}))}),2e3))}chrome.tabs.onUpdated.addListener(t)}))}return n(),!0}if("silentDownloadPDF"===e.action)return chrome.tabs.create({url:e.url,active:!1},(e=>{chrome.tabs.onUpdated.addListener((function t(n,s){n===e.id&&"complete"===s.status&&(chrome.tabs.onUpdated.removeListener(t),chrome.scripting.executeScript({target:{tabId:e.id},function:()=>{const e=document.querySelector("#pdfDown");return!!e&&(e.click(),!0)}},(t=>{setTimeout((()=>{chrome.tabs.remove(e.id)}),2e3),t&&t[0]?.result?o({success:!0}):o({error:"未找到PDF下载按钮"})})))}))})),!0;if("silentBatchDownload"===e.action){const a=e.articles;let i=0;function n(){if(i>=a.length)return void o({success:!0});const e=a[i];chrome.tabs.create({url:e.url,active:!1},(e=>{chrome.tabs.onUpdated.addListener((function t(o,s){o===e.id&&"complete"===s.status&&(chrome.tabs.onUpdated.removeListener(t),chrome.scripting.executeScript({target:{tabId:e.id},function:()=>{const e=document.querySelector("#pdfDown");return!!e&&(e.click(),!0)}},(()=>{setTimeout((()=>{chrome.tabs.remove(e.id),i++,setTimeout(n,2e3)}),2e3)})))}))}))}return n(),!0}if("batchDownloadWithSingleSave"===e.action){const d=e.articles;let u=0;async function s(){if(u>=d.length)return chrome.tabs.sendMessage(t.tab.id,{action:"showNotification",message:`批量下载完成！共下载 ${d.length} 篇文章`}),void o({success:!0});const e=d[u];console.log(`[批量下载] 正在处理第 ${u+1}/${d.length} 篇文章:`,e.title);try{const o=await chrome.tabs.create({url:e.url,active:!1});chrome.tabs.onUpdated.addListener((function n(r,c){r===o.id&&"complete"===c.status&&(chrome.tabs.onUpdated.removeListener(n),chrome.scripting.executeScript({target:{tabId:o.id},function:()=>{const e=document.querySelector("#pdfDown");return!!e&&(e.click(),!0)}},(n=>{const r=n&&n[0]?.result;r&&chrome.tabs.sendMessage(t.tab.id,{action:"showNotification",message:`恭喜，第 ${u+1} 篇文章下载成功！\n文章标题： ${e.title}`}),setTimeout((()=>{chrome.tabs.remove(o.id),u++,setTimeout(s,2e3)}),3e3)})))}))}catch(n){console.error("[批量下载] 处理文章出错:",n),chrome.tabs.sendMessage(t.tab.id,{action:"showNotification",message:`第 ${u+1} 篇文章下载失败：${e.title}`}),u++,setTimeout(s,2e3)}}return console.log(`[批量下载] 开始处理 ${d.length} 篇文章的下载队列`),s(),!0}})),chrome.downloads.onDeterminingFilename.addListener(((e,t)=>{e.filename.endsWith(".pdf")&&(console.log(`[下载] 开始下载文件: ${e.filename}`),t())})),chrome.downloads.onChanged.addListener((e=>{e.state&&console.log("[下载] 文件下载状态变更:",e)}))})();